var thisTarget,isMTinterface;BroadcastChannel&&(thisTarget=window.TvrMT?"MTinterface":"outsideTab",MTBroadCast={BroadcastChannel:!1,observer:!1,thisTarget:thisTarget,isMTinterface:isMTinterface="MTinterface"===thisTarget,isOutsideTab:!isMTinterface,actionWhenVisible:!1,MTDynFrontData:!1,stat:{},init:function(e){MTBroadCast.log("This window",window),MTBroadCast.isOutsideTab&&e&&(this.MTDynFrontData=e,this.listenForBuilderPublish()),this.createBroadcastChannel(),document.addEventListener("visibilitychange",MTBroadCast.visibilityChanged),this.BroadcastChannel.onmessage=function(e){!e||(e=e.data)&&e.update&&e.updateTarget===MTBroadCast.thisTarget&&(MTBroadCast.log("Message received in valid context",e),(e.asset_loading_change||e.adjusted_logic)&&(MTBroadCast.asset_loading_change=!0),MTBroadCast.tabIsHidden()?(MTBroadCast.log("Cache action for later",e),MTBroadCast.actionWhenVisible=e):(MTBroadCast.log("Run action right away",e),MTBroadCast.runAction(e)))}},log:function(){},runAction:function(e){MTBroadCast.update[e.update](e),MTBroadCast.actionWhenVisible=!1},tabIsHidden:function(){return"hidden"===document.visibilityState},visibilityChanged:function(){"visible"===document.visibilityState?setTimeout(function(){MTBroadCast.log("This tab became visible"),MTBroadCast.actionWhenVisible&&MTBroadCast.runAction(MTBroadCast.actionWhenVisible)},20):MTBroadCast.log("This tab became hidden")},createBroadcastChannel:function(){this.BroadcastChannel=new BroadcastChannel("microthemer"),MTBroadCast.log("createBroadcastChannel",this.BroadcastChannel)},broadcastChange:function(e){this.BroadcastChannel||this.createBroadcastChannel(),MTBroadCast.log("postMessage",e),this.BroadcastChannel.postMessage(e)},closeBroadcast:function(){this.BroadcastChannel.close(),this.BroadcastChannel=!1,document.removeEventListener("visibilitychange",MTBroadCast.visibilityChanged)},toggleSyncBrowserTabs:function(e){e?MTBroadCast.init():MTBroadCast.closeBroadcast()},observeTarget:function(t,a){a.observerConfig=a.observerConfig||{};var e=new MutationObserver(function(e){e.forEach(function(e){a.item.apply(this,[t,e].concat(a.args||[]))})});e.observe(t,a.observerConfig),MTBroadCast.observer=e},disconnectObserver:function(){MTBroadCast.observer.disconnect()},docReady:function(e){"complete"===document.readyState||"interactive"===document.readyState?setTimeout(e,1):document.addEventListener("DOMContentLoaded",e)},observeDomChange:function(e,a,t,o,n){t=t||document,o=o||"class";t=(n=n||{}).el||t.querySelector(e);MTBroadCast.log("We have observeDomChange",e,a,t,n),t&&MTBroadCast.observeTarget(t,{observerConfig:{attributeFilter:[o],attributeOldValue:n.attributeOldValue,subtree:n.subtree,childList:n.childList},item:function(e,t){MTBroadCast.log("The mutation",t),("class"===o&&(!n.attributeOldValue&&e.classList.contains(a)||n.attributeOldValue&&t.oldValue.match(n.attributeOldValue))||"style"===o&&e[o][a.property]===a.value||"dataset"===n.change&&e[n.change][a.key]===a.value&&!n.attributeOldValue||t.oldValue===n.attributeOldValue||"disabled"===o&&e.disabled===a||("addedNodes"===o||"removedNodes"===o)&&t[o].length&&t[o][0].classList&&t[o][0].classList.contains(a))&&(MTBroadCast.log("Some kind of update happened in a Builder"),MTBroadCast.BroadcastChannel.postMessage({update:"sitePreview",updateTarget:"MTinterface",MTDynFrontData:MTBroadCast.MTDynFrontData}),n.cb&&n.cb.item.apply(this,n.args||[]))}})},listenForBuilderPublish:function(){MTBroadCast.docReady(function(){MTBroadCast.stat.body=document.body;var e,t=document.body.dataset,a=!1,o=!1;document.documentElement.classList.contains("et-fb-app-frame")&&(a="divi"),t.hasOwnProperty("builderMode")?a="bricks":document.body.classList.contains("brz-ed")?a="brizy":document.body.classList.contains("znpb-editor-preview")?a="zion":"wppb-page-builder"===document.body.id?a="wppb":document.getElementById("breakdance_canvas")?a="breakdance":document.documentElement.dataset.op3Layer?a="optimizePress":document.body.classList.contains("tve_editor_page")?a="thrive":t.hasOwnProperty("elementorDeviceMode")?a="elementor":document.documentElement.classList.contains("fl-builder-is-showing-toolbar")?a="FLBuilder":"CTFrontendBuilder"===document.documentElement.getAttribute("ng-app")&&(a="oxygen"),a&&(MTBroadCast.log("We have a builder",a),e=MTBroadCast[a].click,o=MTBroadCast[a].observe,e&&document.addEventListener("click",e),o&&o())})},divi:{observe:function(){setTimeout(function(){MTBroadCast.observeDomChange("button.et-fb-button--save-draft",!1,window.parent.document,"disabled"),MTBroadCast.observeDomChange("button.et-fb-button--publish",!1,window.parent.document,"disabled")},4e3)}},bricks:{observe:function(){MTBroadCast.observeDomChange("#bricks-preview-message","show")}},brizy:{observe:function(){setTimeout(function(){MTBroadCast.observeDomChange("div.brz-ed-fixed-bottom-panel__btn svg.brz-icon-svg","brz-d-none",window.parent.document)},2e3)}},zion:{observe:function(){MTBroadCast.observeDomChange(".znpb-editor-header__page-save-wrapper--save","znpb-editor-icon-wrapper",window.parent.document,"addedNodes",{subtree:!0,childList:!0})}},wppb:{observe:function(){setTimeout(function(){MTBroadCast.observeDomChange("#wppb-builder-page-tools","wppb-toastr-success",window.parent.document,"addedNodes",{subtree:!0,childList:!0})},2e3)}},breakdance:{observe:function(){setTimeout(function(){MTBroadCast.observeDomChange('button[data-test-id="main-save-button"]',"v-btn__loader",window.parent.document,"removedNodes",{subtree:!0,childList:!0})},2e3)}},optimizePress:{observe:function(){setTimeout(function(){var e=window.parent.document;MTBroadCast.observeDomChange(!1,{key:"op3ButtonStatus",value:"success"},e,"data-op3-button-status",{el:e.getElementById("header").querySelector("a.save"),attributeOldValue:"pending",change:"dataset"})},2e3)}},thrive:{observe:function(){var e=window.parent.document;MTBroadCast.observeDomChange(!1,!1,e,"class",{el:e.getElementById("tcb-editor-settings").querySelector("a.save"),attributeOldValue:"tve-disabled"})}},elementor:{observe:function(){MTBroadCast.observeDomChange("#elementor-panel-saver-button-publish","elementor-disabled",window.parent.document)}},FLBuilder:{observe:function(){MTBroadCast.observeDomChange("div.fl-builder-bar","is-hidden",window.parent.document)}},oxygen:{observe:function(){MTBroadCast.observeDomChange("#ct-page-overlay",{property:"display",value:"none"},window.parent.document,"style")}},fetch:function(e,a){fetch(e).then(e=>e.json()).then(t=>{if(MTBroadCast.log("We fetched some data",t,a),a.cb){let e=a.cb.args||[];e.unshift(t),MTBroadCast.log("Running fetch callback",a.cb),a.cb.item.apply(this,e)}}).catch(e=>{console.error("Error:",e)})},append_url_param:function(e,t,a,o){if(-1<e.indexOf(t))return void 0!==a&&o?e.replace(RegExp(t+"=[^&]+"),t+"="+a):e;o=-1<e.indexOf("?")?"&":"?";return e+o+(t=a?t+"="+a:t)},isSamePage:function(e,t){var a=decodeURIComponent(e["iframe-url"]),o=decodeURIComponent(t["iframe-url"]);return e.post_id===t.post_id&&e.isAdminArea===t.isAdminArea||a===o},assetLoadingChanged:function(e,t,a){var o=JSON.stringify(e)!==JSON.stringify(t),e=document.getElementById("microthemer_g_font-css")?1:0,t=document.getElementById("microthemer-css")?1:0,e=e!==parseInt(a.global_g_fonts),a=t!==parseInt(a.global_css);return MTBroadCast.log("assetLoadingChanged",o,a,e),o||a||e},assetLoadingConfig:function(t,a,o){let n={},e=a.asset_loading,s=e.logic,r;e.global_g_fonts&&(r="microthemer_g_font-css",n[r]={assetHtml:MTBroadCast.generateAssetHTML(r,{css_external:1,url:a.gfURL},a,o)}),e.global_css&&(r="microthemer-css",n[r]={assetHtml:MTBroadCast.generateAssetHTML(r,{css_external:1,url:a.mtURL},a,o)});for(let e=0;e<s.length;e++){var i=s[e],d=i.slug;r="microthemer-"+d+"-css",t[d]&&(n[r]=i,n[r].assetHtml=MTBroadCast.generateAssetHTML(r,i,a,o))}return MTBroadCast.log("The asset loading config",n),n},generateAssetHTML:function(e,t,a,o){var n=t.css_async?'as="style" onload="this.onload=null;this.rel=\'stylesheet\'"':"",s=t.css_external?"":' data-mt-notice="To support browser tab syncing, Microthemer converted a style element to this link element (for admin users only)"';return'<link rel="stylesheet" id="'+e+'" media="all"'+' href="'+(t.url||a.microUrl+"mt/conditional/draft/"+t.slug+".css?nomtcache="+o)+'" '+n+s+">"},allCSSAssetHTML:function(t){let a="",o=Object.keys(t);for(let e=0;e<o.length;e++)a+=t[o[e]].assetHtml;return a},update:{css:function(e){var t,a=MTBroadCast.asset_loading_change||e.asset_loading_change;MTBroadCast.log("checkAssetLoadingChange",a),a&&!MTBroadCast.isSamePage(e.MTDynFrontData,window.MTDynFrontData)?(t=MTBroadCast.append_url_param(decodeURIComponent(window.MTDynFrontData["iframe-url"]),"test_logic",1)+"&test_all=1",MTBroadCast.log("We need to fetch the logic for alt page",t),MTBroadCast.fetch(t,{cb:{item:MTBroadCast.update.action_css,args:[a,e]}})):(MTBroadCast.log("There was no asset loading change, or we have an up to date folderLoading value from MT"),MTBroadCast.update.action_css(e.MTDynFrontData.folderLoading,a,e))},action_css:function(e,t,a){MTBroadCast.log("Data passed to action_css",e,t,a);let o=(new Date).getTime(),n=!(!window.MTDynFrontData||!window.MTDynFrontData.folderLoading)&&window.MTDynFrontData.folderLoading,s=!!t&&MTBroadCast.assetLoadingChanged(n,e,a.asset_loading),r=document.querySelectorAll('link[href*="\\/micro-themes\\/"], link[id^="microthemer"], style[id^="microthemer"]'),i=document.getElementById("mt-placeholder-inline-css"),d=MTBroadCast.assetLoadingConfig(e,a,o);if(s){MTBroadCast.log("There has been an asset loading change for the current page",d);for(let e=0;e<r.length;e++)r[e].remove();i.insertAdjacentHTML("afterend",MTBroadCast.allCSSAssetHTML(d)),window.MTDynFrontData&&(window.MTDynFrontData.folderLoading=e)}else{MTBroadCast.log("No asset loading change, just update cache param / change to link");for(let t=0;t<r.length;t++){let e=r[t];var c;"STYLE"===e.tagName?(c=e.id.replace("inline-",""),MTBroadCast.log("Change to style",c,d[c]),e.insertAdjacentHTML("afterend",d[c].assetHtml),e.remove()):(e.href=MTBroadCast.append_url_param(e.href,"nomtcache",o,!0),MTBroadCast.log("Refreshed param",e.href))}}MTBroadCast.asset_loading_change=!1},sitePreview:function(e){MTBroadCast.log("Received message to reload the site preview",e);var t=window.TvrMT,a=t.MTF,t=(t.TvrUi,t.TvrCom);MTBroadCast.isSamePage(a.getMTDynFrontData(),e.MTDynFrontData)&&t.reload_current_frontend_page(a)}}});